name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'SHA du commit Ã  dÃ©ployer (laissez vide pour le dernier commit de main)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.commit_sha || github.sha }}
          fetch-depth: 0

      - name: Validate commit
        run: |
          if [ -n "${{ inputs.commit_sha }}" ]; then
            echo "ðŸ” Validating custom commit: ${{ inputs.commit_sha }}"
            if ! git cat-file -e ${{ inputs.commit_sha }}^{commit} 2>/dev/null; then
              echo "âŒ Commit ${{ inputs.commit_sha }} not found!"
              exit 1
            fi
            echo "âœ… Commit validated"
          else
            echo "â„¹ï¸  Using latest commit from workflow trigger"
          fi

      - name: Display deployment info
        run: |
          echo "ðŸš€ Deploying commit:"
          git log -1 --oneline
          echo ""
          echo "ðŸ“ Commit SHA: $(git rev-parse HEAD)"
          echo "ðŸ‘¤ Author: $(git log -1 --pretty=format:'%an')"
          echo "ðŸ“… Date: $(git log -1 --pretty=format:'%ar')"

      - name: Set up Node
        uses: actions/setup-node@v5
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_CAN_LOG: ${{ secrets.VITE_CAN_LOG }}

      - name: Copy 404 page
        run: cp dist/index.html dist/404.html

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # âœ… Message de succÃ¨s
      - name: Deployment summary (success)
        if: success()
        run: |
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** $(git log -1 --pretty=%s)" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** $(git log -1 --pretty=%an)" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(git log -1 --pretty=%ar)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

      # âœ… Message d'erreur
      - name: Deployment summary (failure)
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** $(git log -1 --pretty=%s)" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** $(git log -1 --pretty=%an)" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(git log -1 --pretty=%ar)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Please check the logs above for more details." >> $GITHUB_STEP_SUMMARY